<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dados de <%= municipio %></title>
    <script src="/normalizarTexto.js" defer></script> 
    <script src="/buscaMunicipios.js" defer></script>
    <script src="/formatarDadosDaTabela.js" defer></script>
    <script src="/balaoDeAjuda.js" defer></script>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body id="top">
    <div class="container">
        <a href="/">Voltar à pagina anterior</a>
        <br>
        <h1><%= municipio %></h1>
        <br>
        <h2>Código do IGBE: <em><%= codigo %></em></h2>
        <h2>Tipo de Bacia: <em><%= bacia %></em></h2>
        <br>
        <p>Para comparar os dados de <%= municipio %> com outro município, digite o nome do município e selecione a sua opção:</p>
        <input type="text" id="buscaMunicipio" placeholder="Digite o nome do município...">
        <ul id="listaMunicipios" class="lista-municipios" style="display:none;"></ul>
        <br>
        <p>Ou, se preferir, procure o município no mapa abaixo:</p>
        <br>
        <div id="map"></div>
        
        <script>
            window.municipios = <%- JSON.stringify(municipios) %>;
        </script>

        <br>
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Ano</th>
                    <th>Área (ha)</th>
                    <th>Alteração (Valor Absoluto, em ha)</th>
                    <th>Alteração (Valor Relativo, em %)</th>
                </tr>
            </thead>
            <tbody>
                <% dados.forEach(dado => { %>
                    <tr>
                        <td><%= dado["NOME"] %></td>
                        <td><%= dado["ANO"] %></td>
                        <td name="area"><%= dado["AREA (HA)"] %></td>
                        <td class="comparacao"><%= dado["ABSOLUTO"] %></td>
                        <td class="comparacao"><%= dado["RELATIVO"] %></td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
        <br>
        <button id="help-button" class="help-button">?</button>
        <div id="balloon" class="balloon">
            <div id="balloon-close" class="balloon-close">x</div>
            <p>Deseja comparar os dados deste município com os dados de outro município? Comece a digitar o nome do município na caixa de pesquisa e verá uma lista de sugestões. Quando encontrar o município desejado, basta selecioná-lo.<br><br>Ou se preferir, utilize o mapa da região da bacia hidrográfica. Clique ou toque sobre o município desejado e verá um balão com o nome do mesmo, e o link para acessar os dados.</p>
        </div>
        <a href="#top">Voltar ao Topo da Página</a>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var municipiosComCodigo = <%- JSON.stringify(municipiosComCodigo) %>;

        var objetoMunicipiosComCodigo = {};
        municipiosComCodigo.forEach(function(municipio) {
            objetoMunicipiosComCodigo[municipio.CODIGO] = municipio.MUNICIPIO;
        });

        fetch('/data/MunicipiosBacia.geojson')
            .then(response => response.json())
            .then(geojson => {
                var map = L.map('map');

                var bounds = L.geoJSON(geojson).getBounds();
                map.fitBounds(bounds);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                L.geoJSON(geojson, {
                    onEachFeature: function (feature, layer) {
                        var codigoMapa = feature.properties.Codigo;
                        layer.on('click', function (e) {
                            var nomeDoMunicipio = objetoMunicipiosComCodigo[codigoMapa];
                            if (nomeDoMunicipio) {
                                if (codigoMapa != <%= codigo %>) {
                                    var url = window.location.pathname + `/${nomeDoMunicipio}`;
                                    layer.bindPopup(`<a href="${url}">${nomeDoMunicipio}</a>`);
                                } else {
                                    layer.bindPopup(`${nomeDoMunicipio}`);
                                }
                            } else {
                                layer.bindPopup('Nome do município não encontrado.').openPopup();
                            }
                        });
                    }
                }).addTo(map);

            })
            .catch(err => console.error('Erro ao carregar o GeoJSON: ', err));
    </script>
    
</body>
</html>
